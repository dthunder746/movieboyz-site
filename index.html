<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MovieBoyz Fantasy Box Office</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tabulator Bootstrap5 theme -->
  <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">

  <style>
    body { font-size: 0.9rem; }

    #chart-wrapper {
      position: relative;
      height: 350px;
    }
    @media (max-width: 576px) {
      #chart-wrapper { height: 33vh; min-height: 150px; }
    }

    .pick-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      vertical-align: middle;
    }
    .pick-hit      { background: #0d6efd22; color: #6ea8fe; border: 1px solid #0d6efd55; }
    .pick-seasonal { background: #19875422; color: #75b798; border: 1px solid #19875455; }
    .pick-alt      { background: #6f42c122; color: #b08bf8; border: 1px solid #6f42c155; }
    .pick-bomb     { background: #dc354522; color: #ea868f; border: 1px solid #dc354555; }

    [data-bs-theme="light"] .pick-hit      { background: #cfe2ff; color: #052c65; border: 1px solid #9ec5fe; }
    [data-bs-theme="light"] .pick-seasonal { background: #d1e7dd; color: #0a3622; border: 1px solid #a3cfbb; }
    [data-bs-theme="light"] .pick-alt      { background: #e9d7fe; color: #3b0764; border: 1px solid #d0a8ff; }
    [data-bs-theme="light"] .pick-bomb     { background: #f8d7da; color: #58151c; border: 1px solid #f1aeb5; }

    .text-pos { color: #75b798 !important; }
    .text-neg { color: #ea868f !important; }
    .text-neu { color: var(--bs-secondary-color) !important; }

    [data-bs-theme="light"] .text-pos { color: #198754 !important; }
    [data-bs-theme="light"] .text-neg { color: #dc3545 !important; }

    .owner-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }

    /* Tabulator tweaks */
    .tabulator { font-size: 0.85rem; }
    .tabulator-col-title { white-space: normal; word-break: keep-all; overflow-wrap: normal; }
    #table-wrapper { overflow-x: auto; }
    .tabulator .tabulator-col-resize-handle { display: none !important; }

    /* Tabulator dark mode */
    [data-bs-theme="dark"] .tabulator {
      background-color: #212529;
      border-color: #495057;
      color: #dee2e6;
    }
    [data-bs-theme="dark"] .tabulator-header,
    [data-bs-theme="dark"] .tabulator-header .tabulator-col,
    [data-bs-theme="dark"] .tabulator-header .tabulator-col .tabulator-col-content,
    [data-bs-theme="dark"] .tabulator-header .tabulator-col-group {
      background-color: #2b3035;
      color: #dee2e6;
      border-color: #495057;
    }
    [data-bs-theme="dark"] .tabulator-header .tabulator-col.tabulator-sortable:hover {
      background-color: #343a40;
    }
    [data-bs-theme="dark"] .tabulator-col-sorter { color: #adb5bd; }
    [data-bs-theme="dark"] .tabulator-row,
    [data-bs-theme="dark"] .tabulator-row.tabulator-row-even {
      background-color: #212529;
      color: #dee2e6;
      border-color: rgba(255,255,255,0.08);
    }
    [data-bs-theme="dark"] .tabulator-row:hover,
    [data-bs-theme="dark"] .tabulator-row.tabulator-row-even:hover {
      background-color: #343a40 !important;
    }
    [data-bs-theme="dark"] .tabulator-cell { border-color: rgba(255,255,255,0.06); }
    [data-bs-theme="dark"] .tabulator-frozen-rows-holder { background-color: #212529; }

    /* Separators between column groups */
    .tabulator .tabulator-col.week-sep,
    .tabulator .tabulator-col.daily-sep,
    .tabulator-row .tabulator-cell.week-sep,
    .tabulator-row .tabulator-cell.daily-sep {
      border-left: 2px solid var(--bs-border-color) !important;
    }

    /* Latest (in-progress) weekly column â€” italic to signal partial figures */
    .tabulator .tabulator-col.week-latest .tabulator-col-title,
    .tabulator-row .tabulator-cell.week-latest {
      font-style: italic;
    }
  </style>

  <!-- Restore theme before first paint to avoid flash -->
  <script>
    (function () {
      var saved = localStorage.getItem('mbTheme') || 'dark';
      document.documentElement.setAttribute('data-bs-theme', saved);
    })();
  </script>
</head>

<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav class="navbar navbar-expand-sm mb-3 border-bottom">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">ðŸŽ¬ MovieBoyz</span>
    <div class="d-flex align-items-center gap-3 ms-auto">
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="themeSwitch" onchange="toggleTheme(this)">
        <label class="form-check-label" for="themeSwitch">Light</label>
      </div>
    </div>
  </div>
</nav>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="container-fluid px-3">

  <!-- Leaderboard -->
  <h6 class="text-uppercase text-muted fw-semibold mb-2" style="letter-spacing:.08em">Standings</h6>
  <div id="leaderboard" class="d-flex flex-wrap gap-2 mb-4"></div>

  <!-- Chart -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h6 class="text-uppercase text-muted fw-semibold mb-0" style="letter-spacing:.08em">Profit Over Time</h6>
    <button id="reset-zoom" class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.75rem">Reset zoom</button>
  </div>
  <div id="chart-wrapper" class="mb-4">
    <canvas id="profitChart"></canvas>
  </div>

  <!-- Owner filter -->
  <div id="owner-filter" class="d-flex flex-wrap gap-2 align-items-center mb-2"></div>

  <!-- Movie table -->
  <div id="table-wrapper">
    <div id="movie-table"></div>
  </div>

</div>

<!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="container-fluid px-3 mt-3 pb-3 border-top pt-2">
  <small class="text-muted d-block" id="data-updated"></small>
  <small class="text-muted d-block" id="site-updated"></small>
</div>

<!-- â”€â”€ Scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

<script>
// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme(checkbox) {
  var theme = checkbox.checked ? 'light' : 'dark';
  document.documentElement.setAttribute('data-bs-theme', theme);
  localStorage.setItem('mbTheme', theme);
  if (window._chart) {
    var gridColor = theme === 'dark' ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
    var tickColor = theme === 'dark' ? '#aaa' : '#555';
    window._chart.options.scales.x.grid.color = gridColor;
    window._chart.options.scales.x.ticks.color = tickColor;
    window._chart.options.scales.y.grid.color = gridColor;
    window._chart.options.scales.y.ticks.color = tickColor;
    window._chart.options.plugins.legend.labels.color = tickColor;
    window._chart.update();
  }
  if (window._table) {
    window._table.redraw(true);
  }
}

document.addEventListener('DOMContentLoaded', function () {
  var saved = localStorage.getItem('mbTheme') || 'dark';
  var sw = document.getElementById('themeSwitch');
  if (sw) sw.checked = (saved === 'light');
});

// â”€â”€ Formatting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v) {
  if (v === null || v === undefined) return 'â€”';
  var abs = Math.abs(v), M = 1e6, K = 1e3;
  var sign = v < 0 ? '-' : '';
  if (abs >= M)  return sign + '$' + (abs / M).toFixed(1) + 'm';
  if (abs >= K)  return sign + '$' + Math.round(abs / K) + 'k';
  return sign + '$' + Math.round(abs);
}

function colorClass(v) {
  if (v === null || v === undefined) return 'text-neu';
  return v > 0 ? 'text-pos' : v < 0 ? 'text-neg' : 'text-neu';
}

function formatShortDate(d) {
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var parts = d.split('-');
  return months[parseInt(parts[1]) - 1] + ' ' + parseInt(parts[2]);
}

function formatDayMonth(d) {
  var parts = d.split('-');
  return parts[2] + '/' + parts[1];
}

function formatWeekLabel(dates) {
  if (!dates.length) return '';
  var first = dates[0], last = dates[dates.length - 1];
  var fm = first.split('-')[1], lm = last.split('-')[1];
  var ld = parseInt(last.split('-')[2]);
  if (fm === lm) {
    return formatShortDate(first) + 'â€“' + ld;
  }
  return formatShortDate(first) + 'â€“' + formatShortDate(last);
}

function isoWeekBounds(weekKey) {
  // Returns { start, end } as YYYY-MM-DD for the Monâ€“Sun of the given ISO week key
  var parts = weekKey.split('-W');
  var year = parseInt(parts[0]), week = parseInt(parts[1]);
  var jan4 = new Date(Date.UTC(year, 0, 4));
  var day = jan4.getUTCDay() || 7;
  var w1Mon = new Date(jan4.getTime() - (day - 1) * 86400000);
  var wMon  = new Date(w1Mon.getTime() + (week - 1) * 7 * 86400000);
  var wSun  = new Date(wMon.getTime() + 6 * 86400000);
  function iso(dt) {
    return dt.getUTCFullYear() + '-'
      + String(dt.getUTCMonth() + 1).padStart(2, '0') + '-'
      + String(dt.getUTCDate()).padStart(2, '0');
  }
  return { start: iso(wMon), end: iso(wSun) };
}

function fmtTimestamp(d) {
  if (typeof d === 'string') {
    // "2026-02-22 18:30:00" â†’ "26-02-22 18:30:00" (already in local TZ)
    return d.substring(2);
  }
  // Date object â€” render in browser local time
  var yy = String(d.getFullYear()).slice(-2);
  var mo = String(d.getMonth() + 1).padStart(2, '0');
  var dy = String(d.getDate()).padStart(2, '0');
  var hh = String(d.getHours()).padStart(2, '0');
  var mn = String(d.getMinutes()).padStart(2, '0');
  var ss = String(d.getSeconds()).padStart(2, '0');
  return yy + '-' + mo + '-' + dy + ' ' + hh + ':' + mn + ':' + ss;
}

function daysRunning(releaseDate, latestDate) {
  if (!releaseDate || !latestDate || releaseDate > latestDate) return null;
  var a = Date.parse(releaseDate + 'T00:00:00Z');
  var b = Date.parse(latestDate  + 'T00:00:00Z');
  return Math.round((b - a) / 86400000);
}

function grossAsOf(daily_gross, targetDate) {
  if (!daily_gross) return 0;
  var dates = Object.keys(daily_gross).filter(function(d) { return d <= targetDate; }).sort();
  if (!dates.length) return 0;
  return daily_gross[dates[dates.length - 1]] || 0;
}

function dailyDelta(daily_gross, d, prevDate) {
  if (daily_gross[d] === undefined || daily_gross[prevDate] === undefined) return null;
  return daily_gross[d] - daily_gross[prevDate];
}

// â”€â”€ Owner colour palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var PALETTE = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f',
               '#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ac'];

function buildColorMap(owners) {
  var map = {};
  owners.forEach(function(o, i) { map[o] = PALETTE[i % PALETTE.length]; });
  return map;
}

// â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildLeaderboard(data, owners, colorMap, LATEST_DATE) {
  var el = document.getElementById('leaderboard');
  if (!el) return;

  var ranked = owners.map(function(o) {
    var total = data.owners[o] && data.owners[o].total || {};
    return { owner: o, profit: LATEST_DATE && total[LATEST_DATE] !== undefined ? total[LATEST_DATE] : null };
  });
  ranked.sort(function(a, b) {
    if (a.profit === null && b.profit === null) return 0;
    if (a.profit === null) return 1;
    if (b.profit === null) return -1;
    return b.profit - a.profit;
  });

  el.innerHTML = ranked.map(function(item, idx) {
    var rankLabel = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][idx] || (idx + 1) + '.';
    var profitHtml = '<span class="' + colorClass(item.profit) + ' fw-semibold">' + fmt(item.profit) + '</span>';
    return '<div class="d-flex align-items-center gap-2 border rounded px-3 py-2">'
      + '<span>' + rankLabel + '</span>'
      + '<span class="owner-dot" style="background:' + colorMap[item.owner] + '"></span>'
      + '<span class="fw-medium">' + item.owner + '</span>'
      + profitHtml
      + '</div>';
  }).join('');
}

// â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChart(data, owners, colorMap) {
  var theme   = document.documentElement.getAttribute('data-bs-theme') || 'dark';
  var gridCol = theme === 'dark' ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
  var tickCol = theme === 'dark' ? '#aaa' : '#555';

  // Collect all dates across all owners
  var dateSet = new Set();
  owners.forEach(function(o) {
    Object.keys((data.owners[o] && data.owners[o].total) || {}).forEach(function(d) {
      dateSet.add(d);
    });
  });
  var allDates = Array.from(dateSet).sort();

  // Use {x, y} point format for time scale
  var datasets = owners.map(function(owner) {
    var totals = (data.owners[owner] && data.owners[owner].total) || {};
    var points = allDates
      .filter(function(d) { return totals[d] !== undefined; })
      .map(function(d) { return { x: d, y: totals[d] / 1e6 }; });
    return {
      label:            owner,
      data:             points,
      borderColor:      colorMap[owner],
      backgroundColor:  colorMap[owner] + '22',
      borderWidth:      2,
      pointRadius:      0,
      pointHoverRadius: 4,
      tension:          0.3,
      fill:             false,
      spanGaps:         true,
    };
  });

  var ctx = document.getElementById('profitChart');
  window._chart = new Chart(ctx, {
    type: 'line',
    data: { datasets: datasets },
    options: {
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { color: tickCol, boxWidth: 12, padding: 16 }
        },
        tooltip: {
          itemSort: function(a, b) { return b.parsed.y - a.parsed.y; },
          callbacks: {
            label: function(ctx) {
              return ' ' + ctx.dataset.label + ': ' + fmt(ctx.parsed.y * 1e6);
            }
          }
        },
        zoom: {
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode:  'x',
          },
          pan: {
            enabled: true,
            mode:    'x',
          },
          limits: {
            x: { min: 'original', max: 'original', minRange: 7 * 24 * 60 * 60 * 1000 },
          },
        },
      },
      scales: {
        x: {
          type: 'time',
          time: {
            tooltipFormat: 'MMM d, yyyy',
            displayFormats: {
              day:   'MMM d',
              week:  'MMM d',
              month: 'MMM',
              year:  'yyyy',
            },
          },
          ticks: {
            color:       tickCol,
            maxRotation: 0,
            major:       { enabled: true },
            // Bold font on major ticks (month boundaries)
            font: function(context) {
              return context.tick && context.tick.major ? { weight: 'bold' } : {};
            },
          },
          grid: { color: gridCol },
        },
        y: {
          ticks: {
            color:    tickCol,
            callback: function(v) { return fmt(v * 1e6); }
          },
          grid: { color: gridCol },
        }
      }
    }
  });
}

// â”€â”€ Tabulator table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTable(data, owners, colorMap, LATEST_DATE) {

  // Collect all dates that appear in any movie's daily_gross
  var allDailyDates = new Set();
  Object.values(data.movies).forEach(function(m) {
    Object.keys(m.daily_gross || {}).forEach(function(d) { allDailyDates.add(d); });
  });
  var sortedDaily = Array.from(allDailyDates).sort();
  var last7 = sortedDaily.slice(-7);

  // Build weekly buckets (ISO calendar week Monâ€“Sun)
  function isoWeekKey(d) {
    // Returns "YYYY-Www" for sorting; week starts Monday
    var dt = new Date(d + 'T00:00:00Z');
    var day = dt.getUTCDay() || 7; // Mon=1..Sun=7
    dt.setUTCDate(dt.getUTCDate() + 4 - day); // nearest Thursday
    var year = dt.getUTCFullYear();
    var week = Math.ceil(((dt - new Date(Date.UTC(year, 0, 1))) / 86400000 + 1) / 7);
    return year + '-W' + String(week).padStart(2, '0');
  }

  var weekBuckets = {};
  sortedDaily.forEach(function(d) {
    var key = isoWeekKey(d);
    if (!weekBuckets[key]) weekBuckets[key] = [];
    weekBuckets[key].push(d);
  });

  var allWeeks = Object.keys(weekBuckets).sort();
  var last4Weeks = allWeeks.slice(-4);

  // Has any movie been released yet?
  var anyReleased = sortedDaily.length > 0;

  // Build row data
  var rows = Object.entries(data.movies).map(function(entry) {
    var imdb_id = entry[0], movie = entry[1];
    var dg = movie.daily_gross || {};
    var toDateGross  = LATEST_DATE ? grossAsOf(dg, LATEST_DATE) : 0;
    var budget       = movie.budget || 0;
    var toDateProfit = toDateGross - 2 * budget;
    var released     = movie.release_date && LATEST_DATE && movie.release_date <= LATEST_DATE;

    var row = {
      imdb_id:       imdb_id,
      movie_title:   movie.movie_title,
      owner:         movie.owner,
      pick_type:     movie.pick_type,
      release_date:  movie.release_date || 'TBA',
      days_running:  released ? daysRunning(movie.release_date, LATEST_DATE) : null,
      budget:        budget,
      to_date_gross:  released ? toDateGross  : null,
      to_date_profit: released ? toDateProfit : null,
    };

    var last7Start = sortedDaily.length - last7.length;
    last7.forEach(function(d, i) {
      var prevIdx = last7Start + i - 1;
      var prevDate = prevIdx >= 0 ? sortedDaily[prevIdx] : null;
      if (prevDate) {
        var delta = dailyDelta(dg, d, prevDate);
        row['daily_' + d] = delta !== null ? Math.max(0, delta) : null;
      } else {
        // First date in data â€” cumulative value IS the opening day gross
        row['daily_' + d] = dg[d] !== undefined ? Math.max(0, dg[d]) : null;
      }
    });

    last4Weeks.forEach(function(wk) {
      var dates = weekBuckets[wk];
      var total = 0, hasData = false;
      dates.forEach(function(d, i) {
        if (i === 0) return;
        var delta = dailyDelta(dg, d, dates[i - 1]);
        if (delta !== null) { total += Math.max(0, delta); hasData = true; }
      });
      row['week_' + wk] = hasData ? total : null;
    });

    return row;
  });

  // Formatters
  function fmtCell(cell) {
    var v = cell.getValue();
    if (v === null || v === undefined) return '<span class="text-neu">â€”</span>';
    return '<span class="' + colorClass(v) + '">' + fmt(v) + '</span>';
  }

  function fmtGross(cell) {
    var v = cell.getValue();
    if (v === null || v === undefined) return '<span class="text-neu">â€”</span>';
    return fmt(v);
  }

  // Column definitions
  var titleCol = {
    title: 'Movie',
    field: 'movie_title',
    frozen: true,
    minWidth: 190,
    formatter: function(cell) {
      var row = cell.getRow().getData();
      var dot = '<span class="owner-dot" style="background:' + (colorMap[row.owner] || '#888') + '"></span>';
      var badge = '<span class="pick-badge pick-' + row.pick_type + '">' + row.pick_type + '</span>';
      return dot + cell.getValue() + ' ' + badge;
    },
    formatterParams: { html: true },
  };

  var dailyCols = last7.slice().reverse().map(function(d, i) {
    return {
      title: formatDayMonth(d),
      field: 'daily_' + d,
      hozAlign: 'right',
      minWidth: 68,
      cssClass: i === 0 ? 'daily-sep' : '',
      formatter: fmtCell,
      formatterParams: { html: true },
      sorter: 'number',
    };
  });

  var weeklyCols = last4Weeks.slice().reverse().map(function(wk, i) {
    var isLatest = (i === 0);
    var title;
    if (isLatest) {
      var b = isoWeekBounds(wk), sm = b.start.split('-'), em = b.end.split('-');
      title = sm[1] === em[1]
        ? formatShortDate(b.start) + 'â€“' + parseInt(em[2])
        : formatShortDate(b.start) + 'â€“' + formatShortDate(b.end);
    } else {
      title = formatWeekLabel(weekBuckets[wk]);
    }
    return {
      title: title,
      field: 'week_' + wk,
      hozAlign: 'right',
      minWidth: 90,
      cssClass: [i === 0 ? 'week-sep' : null, isLatest ? 'week-latest' : null].filter(Boolean).join(' '),
      formatter: fmtCell,
      formatterParams: { html: true },
      sorter: 'number',
    };
  });

  var columns = [
    {
      title: 'Movie Details',
      columns: [titleCol],
    },
    {
      title: 'Opening Date',
      field: 'release_date',
      minWidth: 130,
      sorter: 'string',
    },
    {
      title: 'Days',
      field: 'days_running',
      hozAlign: 'right',
      minWidth: 72,
      formatter: function(cell) {
        var v = cell.getValue();
        return v !== null && v !== undefined ? String(v) : '<span class="text-neu">â€”</span>';
      },
      formatterParams: { html: true },
      sorter: 'number',
    },
    {
      title: 'Owner',
      field: 'owner',
      minWidth: 100,
      formatter: function(cell) {
        var o = cell.getValue();
        return '<span class="owner-dot" style="background:' + (colorMap[o] || '#888') + '"></span>' + o;
      },
      formatterParams: { html: true },
    },
    {
      title: 'Gross TD',
      field: 'to_date_gross',
      hozAlign: 'right',
      minWidth: 95,
      formatter: fmtGross,
      formatterParams: { html: true },
      sorter: 'number',
    },
    {
      title: 'Profit TD',
      field: 'to_date_profit',
      hozAlign: 'right',
      minWidth: 95,
      formatter: fmtCell,
      formatterParams: { html: true },
      sorter: 'number',
    },
  ];

  if (anyReleased) {
    if (dailyCols.length > 0) {
      columns.push({
        title: 'Daily Gross (last 7 days)',
        columns: dailyCols,
      });
    }
    if (weeklyCols.length > 0) {
      columns.push({
        title: 'Weekly Gross',
        columns: weeklyCols,
      });
    }
  }

  window._table = new Tabulator('#movie-table', {
    data:             rows,
    columns:          columns,
    layout:           'fitDataFill',
    responsiveLayout: false,
    initialSort:      [{ column: 'release_date', dir: 'asc' }],
    columnHeaderVertAlign: 'bottom',
    resizableColumns: false,
  });
}

// â”€â”€ Owner filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildOwnerFilter(owners, colorMap) {
  var container  = document.getElementById('owner-filter');
  var activeSet  = new Set(); // empty = show all

  function applyFilter() {
    if (!window._table) return;
    if (activeSet.size === 0) {
      window._table.clearFilter();
    } else {
      window._table.setFilter('owner', 'in', Array.from(activeSet));
    }
  }

  function render() {
    container.innerHTML = '';

    owners.forEach(function(owner) {
      var active = activeSet.has(owner);
      var btn = document.createElement('button');
      btn.className = 'btn btn-sm ' + (active ? 'btn-primary' : 'btn-outline-secondary');
      if (active) btn.style.backgroundColor = colorMap[owner];
      btn.style.borderColor = colorMap[owner];
      btn.innerHTML = '<span class="owner-dot" style="background:' + colorMap[owner] + '"></span>' + owner;
      btn.addEventListener('click', function() {
        if (activeSet.has(owner)) activeSet.delete(owner);
        else activeSet.add(owner);
        applyFilter();
        render();
      });
      container.appendChild(btn);
    });

    var clear = document.createElement('button');
    clear.className = 'btn btn-sm btn-outline-secondary';
    clear.textContent = 'Clear';
    clear.addEventListener('click', function() {
      activeSet.clear();
      applyFilter();
      render();
    });
    container.appendChild(clear);
  }

  render();
}

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init(data) {
  // LATEST_DATE â€” max date with actual gross data, used by table for accuracy
  var allGrossDates = Object.values(data.movies || {}).flatMap(function(m) {
    return Object.keys(m.daily_gross || {});
  });
  var LATEST_DATE = allGrossDates.length ? allGrossDates.slice().sort().at(-1) : null;

  // LATEST_PROFIT_DATE â€” max date in owner totals, used by leaderboard
  var allProfitDates = Object.values(data.owners || {}).flatMap(function(o) {
    return Object.keys(o.total || {});
  });
  var LATEST_PROFIT_DATE = allProfitDates.length ? allProfitDates.slice().sort().at(-1) : null;

  var owners   = Object.keys(data.owners || {}).sort();
  var colorMap = buildColorMap(owners);

  // Footer: data.json fetched_at
  if (data.fetched_at) {
    var elData = document.getElementById('data-updated');
    if (elData) elData.textContent = 'data.json updated ' + fmtTimestamp(data.fetched_at);
  }

  // Footer: index.html last commit via GitHub API
  fetch('https://api.github.com/repos/dthunder746/movieboyz-site/commits?path=index.html&per_page=1')
    .then(function(r) { return r.json(); })
    .then(function(commits) {
      if (commits && commits[0] && commits[0].commit) {
        var dateStr = commits[0].commit.committer.date;
        var elSite = document.getElementById('site-updated');
        if (elSite) elSite.textContent = 'index.html updated ' + fmtTimestamp(new Date(dateStr));
      }
    })
    .catch(function() {});

  buildLeaderboard(data, owners, colorMap, LATEST_PROFIT_DATE);
  buildChart(data, owners, colorMap);
  buildTable(data, owners, colorMap, LATEST_DATE);
  buildOwnerFilter(owners, colorMap);

  document.getElementById('reset-zoom').addEventListener('click', function() {
    if (window._chart) window._chart.resetZoom();
  });
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var DATA_URL = 'https://raw.githubusercontent.com/dthunder746/movieboyz-site/data/data.json?t=' + Date.now();
fetch(DATA_URL)
  .then(function(r) {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  })
  .then(init)
  .catch(function(err) {
    document.body.innerHTML += '<div class="alert alert-danger m-3">Failed to load data.json: ' + err.message + '</div>';
  });
</script>
</body>
</html>
